<script>
jQuery.noConflict();

//FIXME Ajax request every second(or more) to ask the server for the most recent updated_at, and compare with ours. Reload content if newer.  
/*jQuery(document).ready(function(){
	setTimeout("window.location.reload()",60000*5);
});*/

jQuery(document).ready(function($){
 
  jQuery.fn.check = function(){
	jQuery.ajax({
      type: 'POST',
      data: "itemid="+$(this).val()+"&state=done",
	  dataType: "json",
      url: window.location.href.replace("#","")+"/"+$(this).parent().parent().attr("class").split(" ")[0].split("-")[1]+"/changeState",
      error: function() {
        $(".flash").renderFlash("notifier.actions.failure", "error", {"action":"check"});
		return false;
      },
      success: function(r) {
	    	$("#list_"+r.id).html(r.html);
			$("#list_"+r.id).show();
      }
    });
  }

  jQuery.fn.uncheck = function(){
	jQuery.ajax({
      type: 'POST',
      data: "itemid="+$(this).val()+"&state=notdone",
	  dataType: "json",
      url: window.location.href.replace("#","")+"/"+$(this).parent().parent().attr("class").split(" ")[0].split("-")[1]+"/changeState",
      error: function() {
        $(".flash").renderFlash("notifier.actions.failure", "error", {"action":"check"});
		return false;
      },
      success: function(r) {
	    	$("#list_"+r.id).html(r.html);
			$("#list_"+r.id).show();
      }
    });
  }	

  $(".title").click(function(event){
	$(this).next().fadeToggle("slow","linear");
	event.preventDefault();
  });

  $(".add_link").click(function(){
	$(this).parent().hide();
	$(this).parent().next().show();
	
	return false;
  });

 $(".done_adding_link").click(function(){
	$(this).parent().parent().parent().parent().hide();
	$(this).parent().parent().parent().parent().prev().show();
	
	return false;
 });

 $(".sortable").sortable({
	connectWith: ".connectable",
	stop: function(event,ui) {
		
		var classToSerialize = "."+ui.item.parent().attr("class").split(" ")[0];
		var order = $(classToSerialize).sortable("serialize");
		var newOrder = order.replace(/item/g,"items");
	
		jQuery.ajax({
	      type: 'POST',
	      data: "list="+ui.item.parent().parent().parent().attr("id").split("_")[1]+"&item="+ui.item.attr("id").split("_")[1]+"&"+newOrder,
	      url: window.location.href.replace("#","")+"/sortList",
	      error: function() {
	        $(".flash").renderFlash("notifier.actions.failure", "error", {"action":"sort"});
			return false;
	      },
	      success: function(r) {
		  		
	      }
	    });
	}
 });
		
	
  $( ".datepicker" ).datepicker({
  	autoSize: true
  });

	var cancelFunc = function(){
		jQuery.ajax({
	      type: 'GET',
	      url: window.location.href.replace("#","")+"/"+$(this).parent().parent().parent().parent().parent().children(':nth-child(1)').attr("id")+"/cancel",
		  dataType: "json",
	      error: function() {
	        $(".flash").renderFlash("notifier.actions.failure", "error", {"action":"cancel"});
			return false;
	      },
	      success: function(r) {
		  		$(".todo_content-"+r.id).html(r.html);
	      }
	    });
  	}

  jQuery.fn.edit = 	function(){
				jQuery.ajax({
			      type: 'GET',
			      url: window.location.href.replace("#","")+"/"+$(this).attr("id").split("_")[1]+"/edit",
				  dataType: "json",
			      error: function() {
			        $(".flash").renderFlash("notifier.actions.failure", "error", {"action":"edit"});
					return false;
			      },
			      success: function(r) {
				  		$(".todo_content-"+r.id).html(r.html);
						$( ".datepicker" ).datepicker({autoSize: true});
						$(".cancel_link").click(cancelFunc);
			      }
			    });

			return false;
		  }

  $(".edit_item").click(function(){
 		$(this).edit();
  });
	
  $(".delete_item").click(function(){
		jQuery.ajax({
	      type: 'DELETE',
	      url: window.location.href.replace("#","").replace("to_do_lists","to_dos")+"/"+$(this).attr("id").split("_")[1],
	      error: function() {
	        $(".flash").renderFlash("notifier.actions.failure", "error", {"action":"destroy"});
			return false;
	      },
	      success: function(r) {
		  		$("#item_"+r).remove();
	      }
	    });

	return false;
  });

  jQuery.fn.expand = function(){
		var itemId = $(this).attr("id").split("_")[1];
		$("#collapse_"+itemId).show();
		$(this).hide();
		$(this).parent().next().show();
  }

  jQuery.fn.collapse = function(){
		var itemId = $(this).attr("id").split("_")[1];
		$("#expand_"+itemId).show();
		$(this).hide();
		$(this).parent().next().hide();
  }	
}); 

</script>

<!-->FIXME: Add generic sidebar placer for plugins<-->
  <% content_for :sidebar do -%>
    <%= render :partial => 'admin/to_do_lists/sidebar.html.erb', :locals => {:project_id => params[:project_id]}  %>
  <% end -%>


<% counter = 1%>
<% @lists.each do |list| %>
	<div class="title">
		<h2><%= link_to list.name, admin_project_to_do_lists_path %></h2>
	</div>
	<div id="list_<%= list.id %>" class="the_list-<%= list.id %>" style="display:none;">
	  <%= render :partial => 'admin/to_do_lists/list.html.erb', :locals => {:list => list} %>
	</div>
<% counter = counter+1 %>
<% end %>	

