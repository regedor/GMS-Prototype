<script>
jQuery.noConflict();

//FIXME Ajax request every second(or more) to ask the server for the most recent updated_at, and compare with ours. Reload content if newer.  
jQuery(document).ready(function(){
	setTimeout("window.location.reload()",60000*5);
});

jQuery(document).ready(function($){
 

  $(".done_todos .done_todo [type=checkbox]").click(uncheck=function(){
	jQuery.ajax({
      type: 'POST',
      data: "id="+$(this).val()+"&state=notdone",
      url: window.location.href+"/changeState",
      error: function() {
        $(".flash").renderFlash("notifier.actions.failure", "error", {"action":"uncheck"});
      },
      success: function(r) {
		$(".done_todos .done_todo #"+r).parent().appendTo(".not_done");
		$(".done_todos .done_todo #"+r).parent().remove();
		$(".not_done .done_todo #"+r).parent().addClass("todo");
		$(".not_done .done_todo #"+r).parent().removeClass("done_todo");
		$(".not_done .todo #"+r).removeAttr("checked");
      }
    });

	$(this).bind("click",check);
	
  });
	
  $(".todos .todo [type=checkbox]").click(check=function(){
	jQuery.ajax({
      type: 'POST',
      data: "id="+$(this).val()+"&state=done",
      url: window.location.href+"/changeState",
      error: function() {
        $(".flash").renderFlash("notifier.actions.failure", "error", {"action":"check"});
      },
      success: function(r) {
		$(".not_done .todo #"+r).parent().appendTo(".done_todos");
	    $(".not_done .todo #"+r).parent().remove();	
		$(".done_todos .todo #"+r).parent().addClass("done_todo");
		$(".done_todos .todo #"+r).parent().removeClass("todo");			
      }
    });
	
	$(this).bind("click",uncheck);
  });

  $(".title").click(function(event){
	$(".the_list").fadeToggle("slow","linear");
	event.preventDefault();
  });
	
}); 
</script>


<% @lists.each do |list| %>
<div class="title">
	<h2><%= link_to list.name, admin_project_to_do_lists_path %></h2>
</div>
<div class="the_list" style="display:none;">
  <div class="description">
    <%= list.description %>
  </div>
  <div class="todos">
    <% divided_hash = list.divide_done_todos %>	
    
    <div class="not_done">	
      <% divided_hash[:notDone].each do |todo| %>
        <div class="todo">
          <input type="checkbox" id="<%= todo.id %>" value="<%= todo.id %>" /> 	
          <span class="todo_desc"><%= todo.description %></span>
        </div>
      <% end %>
    </div>
  
	<div class="add_todo">
		<%= form_tag({:controller => "to_dos", :action => "create"}, :method => "post", :class => "new_todo_form") %>
		<p><%=h t("admin.to_do.add_new") %></p>
	</div>	

    <div class="done_todos">
  	<% divided_hash[:done].each do |todo| %>
  	  <div class="done_todo">
  	    <input type="checkbox" id="<%= todo.id %>" value="<%= todo.id %>" checked="yes" />
  	    <span class="todo_desc"><%= todo.description %></span>
  	  </div>
  	<% end %>
    </div>	
  </div>
</div>
<% end %>	

