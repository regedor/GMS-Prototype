<script>
jQuery(document).ready(function($){

  // Load table
  $.getJSON(window.location.href.replace(/\#.*/,"").replace("edit","positions.json"),function(r) {
    for(var i=0;i<r.groups.length;i++)
    {
      var position = "";
      if(r.positions[i] !== null)
        position = r.positions[i].position.name
    
      append_position_line(r.groups[i].group,position);
    }
  });

  $("#record_groups_input").delegate('input:checkbox', 'click', function(event){
    if($(this).is(":checked"))
    {
      var group = {
        'id': event.target.defaultValue,
        'name': $.trim(event.target.nextSibling.data)
      };
      load_position_for_group(group);
    }
    else
      $("#positions tbody td[abbr='"+event.target.defaultValue+"']").parent().remove();

  });

  $("fieldset.buttons").delegate('#update-button','click',function(event){
    var form = $("form.formtastic"),
        encodedURIofPositions = getPositionsURI();

    jQuery.ajax({
      type: 'PUT',
      data: form.serialize()+encodedURIofPositions,
      url: window.location.href.replace(/\#.*/,"").replace("edit",""),
      dataType: "json",
      error: function() {
        $("#flash").renderFlash("notifier.actions.failure", "error", {"action":"actualizar utilizador"});
        return false;
      },
      success: function(location) {
        window.location.href = location;
      }
    });

    event.preventDefault();
  });

  function load_position_for_group(group)
  {
    $.getJSON(window.location.href.replace(/\#.*/,"").replace("edit","positions.json")+"?group_id="+group.id, function(r) {
      if(r.groups === null)
        append_position_line(group,"");
      else
      {
        for(var i=0;i<r.groups.length;i++)
        {
          var position = "";
          if(r.positions[i] !== null)
            position = r.positions[i].position.name
          
          append_position_line(r.groups[i].group,position);
        }
      }
    });
  }

  function append_position_line(group,position)
  {
    var html_str = "<tr><td class='group' abbr='"+group.id+"'>"+group.name+"</td> \
                    <td class='position'><input type='text' value='"+position+"' /></td></tr>";
    $("#positions tbody").append(html_str);
  }

  function getPositionsURI()
  {
    var groups = $("#positions .group"),
        positions = $("#positions .position").find("input"),
        uri = [];

    for(var i=0;i<groups.length;i++)
    {
      uri.push("&record[positions][groups][]=",encodeURI(groups[i].abbr),"&record[positions][names][]=",encodeURI(positions[i].value));
    }

    return uri.join("");
  }
});
</script>

<div class="content">
  <div class="inner">
    <h2><%= I18n::t('admin.users.form.edit') + ' - ' + link_to(h(@record.nickname_or_first_and_last_name), admin_user_path(@record)) %></h2>
    <% semantic_form_for :record, @record, 
                         :url => admin_user_path(@record), 
                         :html => { :method => :put, :id => "edit_user_#{@record.id}", :multipart => true } do |form| -%>
      <%= render :partial => 'form', :locals => { :form => form } %>

      <table id="positions">
        <thead>
          <th><%= I18n::t('admin.users.form.positions_table.group') %></th>
          <th><%= I18n::t('admin.users.form.positions_table.position') %></th>
        </thead>
        <tbody>
        </tbody>
      </table>

      <% form.buttons do -%>
        <%= form.button      :label => I18n::t('admin.users.form.update_button'),
                             :button_html => { :class => 'button positive', :id => "update-button" } %>
        <%= form.button_link I18n::t('admin.users.form.cancel_button'), admin_users_path,
                             :button_html => { :class => 'button negative' } %>
      <% end -%>
    <% end -%>
  </div>
</div>
